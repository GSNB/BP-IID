<!DOCTYPE html>
<html>

<head>
    <title>IID Module Configuration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="axios.min.js"></script>
    <style>
        body {
            font-family: Calibri, sans-serif;
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            background: #005AA7;
            /* fallback for old browsers */
            background: -webkit-linear-gradient(15deg, #FFFDE4, #005AA7);
            /* Chrome 10-25, Safari 5.1-6 */
            background: linear-gradient(15deg, #FFFDE4, #005AA7);
            /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
        }

        body,
        html {
            min-height: 100%;
            margin: 0;
        }

        h3 {
            text-align: center;
        }

        p {
            text-align: justify;
        }

        #deviceSelect select {
            padding: 5px 8px;
            width: 130%;
            border: none;
            box-shadow: none;
            background: transparent;
            background-image: none;
            -webkit-appearance: none;
        }

        #deviceSelect select:focus {
            outline: none;
        }

        #deviceSelect option {
            padding: 5px 8px;
            zoom: 1.1;
        }

        #flexbox {
            margin: 30px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 1);
            border: 2px solid #303030;
            border-radius: 7px;
            -webkit-box-shadow: 0px 0px 10px 1px rgba(0, 0, 0, 0.5);
            -moz-box-shadow: 0px 0px 10px 1px rgba(0, 0, 0, 0.5);
            box-shadow: 0px 0px 10px 1px rgba(0, 0, 0, 0.5);
            max-width: 400px;
        }

        #wrapper {
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        input, #deviceSelect {
            margin-top: 10px;
            width: 100%;
            display: block;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
            background: rgba(255, 255, 255, 1);
            padding: 5px 10px;
            box-sizing: border-box;
        }

        hr {
            margin: 15px 0;
        }

        .description {
            font-size: x-small;
            font-weight: bold;
        }

        .err {
            margin-top: 5px;
            margin-bottom: 0;
            color: red;
            font-size: small;
            font-weight: bold;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.15s ease-out;
        }

        select,
        input:hover {
            border: 1px solid black;
            transition: border 0.5s ease-in;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <div id="flexbox">
            <h3>IID Module configuration panel</h3>
            <hr>
            <p>To work properly, the IID Module requires a paired breathalyzer device. Make sure that the device
                you're
                trying to find is powered and within range of bluetooth connection.</p>
            <form>
                <label for="cars">Select breathalyzer device</label>
                <select name="devices" id="deviceSelect">
                    <option value="" disabled selected>Select device</option>
                </select>
                <p class="err" id="deviceerr">No device selected.</p>
                <br>
                <input type="button" onclick="saveBTSettings()" value="Save Bluetooth configuration">
            </form>
            <hr>
            <p>You can change name (SSID) and password of this device's WiFi hotspot. Please make sure that the
                password is strong and at least 8 characters long.</p>
            <form>
                <label for="cars">Name this device's hostspot</label>
                <input type="text" name="ssid" placeholder="SSID">
                <p class="err" id="ssiderr">SSID has to be at least 4 characters long.</p>

                <br>

                <label for="cars">Set up a strong password</label>
                <input type="password" name="password" placeholder="Password">
                <p class="err" id="passerr">Password has to be at least 8 characters long.</p>

                <br>
                <input type="button" onclick="saveWIFISettings()" value="Save WiFi configuration">
            </form>
            <hr>
            <p class="description">*All settings will be saved. You can change them at any time.</p>
        </div>
    </div>
</body>
<script>
    var devicesListJSON = new Object;
    var postData;

    const transFormRequest = (formValues) => {
        const formData = new FormData();
        Object.keys(formValues).map((key) => {
            formData.append(key, formValues[key])
        })
        return formData;
    }

    async function getConfiguration() {
        const response = await fetch('/api/getconfiguration');
        if (!response.ok) {
            const message = `An error has occured: ${response.status}`;
            throw new Error(message);
        }
        const data = await response.json();
        console.log(data);
        return data;
    }

    async function saveBTSettings() {
        if (document.getElementById("deviceSelect").selectedOptions[0].innerHTML != "No devices found") {
            if ('savedDevice' in devicesListJSON && document.getElementById("deviceSelect").value == devicesListJSON.deviceSelect.Name) {
                postData = devicesListJSON.deviceSelect.Address;
            }
            else if ("devices" in devicesListJSON) {
                for (var i = 0; i < devicesListJSON.devices.length; i++) {
                    if (devicesListJSON.devices[i].Name == document.getElementById("deviceSelect").value) {
                        postData = devicesListJSON.devices[i].Address;
                        break;
                    }
                }
            }
            const response = axios.post("/api/savebtsettings", transFormRequest({
                Address: postData
            }));
            console.log(response);
            return response;
        } else {
            document.getElementById("deviceerr").style.maxHeight = "500px";
        }
    }

    async function saveWIFISettings() {
        var ssid = document.getElementsByName("ssid")[0].value;
        var password = document.getElementsByName("password")[0].value;

        if (ssid.length > 4 && password.length >= 8) {
            const response = axios.post("/api/savewifisettings", transFormRequest({
                SSID: ssid,
                Password: password
            }));
            console.log(response);
            return response;
        }
        else {
            if (ssid.length <= 4) {
                document.getElementById("ssiderr").style.maxHeight = "500px";
            }
            if (password.length <= 8) {
                document.getElementById("passerr").style.maxHeight = "500px";
            }
        }

    }

    getConfiguration().then(data => {
        if (data.devices.length > 0) {
            for (var i = 0; i < data.devices.length; i++) {
                var option = document.createElement("option");
                option.text = data.devices[i].Name;
                document.getElementById("deviceSelect").add(option);
            }
            devicesListJSON = data;
        } else {
            document.getElementById("deviceSelect").options[0].innerHTML = "No devices found";
        }
        document.getElementsByName("ssid")[0].value = data.wifi.SSID;
        if ('savedDevice' in data) {
            document.getElementById("deviceSelect").options[0].innerHTML = data.deviceSelect.Name;
        }
    }).catch(error => {
        document.getElementById("deviceSelect").options[0].innerHTML = "No devices found";
        console.log(error.message); // 'An error has occurred: 404'
    });

</script>

</html>